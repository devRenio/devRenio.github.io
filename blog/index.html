---
layout: blog
paginate: 5
---

<div
  class="blog-search"
  style="
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 6px;
    margin: 0 0 10px 0;
  "
>
  <input
    id="post-search-input"
    type="search"
    placeholder="제목/본문 검색"
    style="
      width: 220px;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
    "
    aria-label="포스트 검색"
  />
  <button
    id="post-search-btn"
    type="button"
    style="padding: 6px 10px; font-size: 13px"
  >
    검색
  </button>

  <div id="no-results" style="display: none; margin-left: 6px; color: #999">
    검색 결과가 없습니다.
  </div>
</div>

<hr style="margin-bottom: 1.5em" />
<p id="category-title" style="font-size: 17px"><b>최근 포스트</b></p>

<hr />
<section class="blog-posts">
  <ul>
    {% assign sorted_posts = site.blog | sort: 'date' | reverse %} {% for post
    in sorted_posts %}
    <li class="blog-entry" data-categories="{{ post.categories | join: ',' }}">
      <a href="{{ post.url }}" class="blog-entry-link">
        <h2>{{ post.title }}</h2>
        <hr
          style="height: 0.3px; background-color: rgb(33, 33, 32); border: none"
        />
        <p>{{ post.excerpt | strip_html | truncate: 150 }}</p>
        <small>{{ post.date | date: "%Y-%m-%d %H시" }}</small>
      </a>
    </li>
    {% endfor %}
  </ul>

  <div class="pagination"></div>
  <br />
</section>

<script>
  (function () {
    var input = document.getElementById("post-search-input");
    if (!input) return;

    var entries = Array.prototype.slice.call(
      document.querySelectorAll(".blog-posts .blog-entry")
    );
    var paginationEl = document.querySelector(".pagination");
    var countEl = document.getElementById("search-count");
    var noResultsEl = document.getElementById("no-results");
    var titleEl = document.getElementById("category-title");
    var pageSize = 5;
    var currentPage = 1;

    function normalize(text) {
      return (text || "").toString().toLowerCase().replace(/\s+/g, " ").trim();
    }

    function getMatched() {
      return entries.filter(function (li) {
        return li.getAttribute("data-match") !== "0";
      });
    }

    function renderPagination(totalPages) {
      if (!paginationEl) return;
      if (totalPages <= 1) {
        paginationEl.innerHTML = "";
        return;
      }

      var html = "";
      html += '<a href="#" class="prev-next-button" data-page="prev">◀</a>';
      var pages = [];
      var start = Math.max(1, currentPage - 2);
      var end = Math.min(totalPages, currentPage + 2);

      // 항상 첫 페이지
      pages.push(1);

      // 첫 페이지와 시작 사이 간격 처리
      if (start > 2) {
        pages.push("...");
      }

      // 윈도우 구간 (1, totalPages는 중복 피함)
      for (var i = start; i <= end; i++) {
        if (i !== 1 && i !== totalPages) {
          pages.push(i);
        }
      }

      // 끝 구간 앞 간격 처리
      if (end < totalPages - 1) {
        pages.push("...");
      }

      // 항상 마지막 페이지
      if (totalPages > 1) {
        pages.push(totalPages);
      }

      pages.forEach(function (p) {
        if (p === "...") {
          html += '<span class="page-ellipsis">…</span>';
        } else {
          var cls = "page-number" + (p === currentPage ? " current" : "");
          html +=
            '<a href="#" class="' +
            cls +
            '" data-page="' +
            p +
            '">' +
            p +
            "</a>";
        }
      });
      html += '<a href="#" class="prev-next-button" data-page="next">▶</a>';
      paginationEl.innerHTML = html;

      Array.prototype.forEach.call(
        paginationEl.querySelectorAll("[data-page]"),
        function (a) {
          a.addEventListener("click", function (e) {
            e.preventDefault();
            var raw = this.getAttribute("data-page");
            if (raw === "prev") {
              renderPage(currentPage - 1);
            } else if (raw === "next") {
              renderPage(currentPage + 1);
            } else {
              var t = parseInt(raw, 10) || 1;
              renderPage(t);
            }
            try {
              window.scrollTo({ top: 0, behavior: "smooth" });
            } catch (_) {
              window.scrollTo(0, 0);
            }
          });
        }
      );
    }

    function renderPage(page) {
      var matched = getMatched();
      var total = matched.length;
      var totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(Math.max(1, page), totalPages);

      // 모두 숨기고
      entries.forEach(function (li) {
        li.style.display = "none";
      });

      var start = (currentPage - 1) * pageSize;
      var end = start + pageSize;
      matched.slice(start, end).forEach(function (li) {
        li.style.display = "";
      });

      if (countEl) countEl.textContent = String(total);
      if (noResultsEl) noResultsEl.style.display = total ? "none" : "";
      renderPagination(totalPages);
    }

    function filter() {
      var q = normalize(input.value);
      var visible = 0;

      entries.forEach(function (li) {
        var title = normalize((li.querySelector("h2") || {}).textContent);
        var body = normalize((li.querySelector("p") || {}).textContent);
        var match = !q || title.indexOf(q) !== -1 || body.indexOf(q) !== -1;
        li.setAttribute("data-match", match ? "1" : "0");
        if (match) visible++;
      });

      if (q) {
        if (titleEl) titleEl.innerHTML = "<b>검색 결과</b>";
        if (countEl) {
          countEl.textContent = String(visible);
        }
        if (noResultsEl) noResultsEl.style.display = visible ? "none" : "";
      } else {
        if (titleEl) titleEl.innerHTML = "<b>최근 포스트</b>";
        if (noResultsEl) noResultsEl.style.display = "none";
      }

      renderPage(1);
      try {
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (_) {
        window.scrollTo(0, 0);
      }
    }

    var btn = document.getElementById("post-search-btn");
    if (btn) {
      btn.addEventListener("click", filter);
    }
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        filter();
      }
    });

    // 검색어가 쿼리에 있으면 초기값 설정 (?q=...)
    try {
      var params = new URLSearchParams(window.location.search);
      var q = params.get("q");
      if (q) {
        input.value = q;
        filter();
      }
    } catch (e) {}

    // 초기 로드 시 전체 기준으로 페이지네이션 구성
    if (!input.value) {
      entries.forEach(function (li) {
        li.setAttribute("data-match", "1");
      });
      renderPage(1);
    }
  })();
</script>
