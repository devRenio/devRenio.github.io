---
layout: blog
paginate: 5
---

<div class="blog-search" style="margin: 0 0 1.5rem 0; text-align: right">
  <input
    id="post-search-input"
    type="search"
    placeholder="제목/본문 검색..."
    style="
      width: 240px;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: #fff;
      color: #333;
      box-sizing: border-box;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      margin-right: 8px;
    "
    aria-label="포스트 검색"
  />
  <button
    id="post-search-btn"
    type="button"
    style="
      padding: 8px 16px;
      font-size: 14px;
      color: #000;
      background-color: #fcfbf5;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    "
  >
    검색
  </button>
  <div
    id="no-results"
    style="display: none; margin-top: 8px; color: #999; font-size: 13px"
  >
    검색 결과가 없습니다.
  </div>
</div>

<hr />
<p id="category-title" style="font-size: 17px"><b>최근 포스트</b></p>

<hr />
<section class="blog-posts">
  <ul>
    {% assign sorted_posts = site.blog | sort: 'date' | reverse %} {% for post
    in sorted_posts %}
    <li class="blog-entry" data-categories="{{ post.categories | join: ',' }}">
      <a href="{{ post.url }}" class="blog-entry-link">
        <h2>{{ post.title }}</h2>
        <hr
          style="height: 0.3px; background-color: rgb(33, 33, 32); border: none"
        />
        <p style="margin-bottom: 0.2em; margin-top: 0">
          {{ post.excerpt | strip_html | truncate: 150 }}
        </p>
        <small>{{ post.date | date: "%Y-%m-%d %H시" }}</small><br />
        <small>{{ post.categories | join: ", " }}</small>
      </a>
    </li>
    {% endfor %}
  </ul>

  <div class="pagination"></div>
  <br />
</section>

<script>
  (function () {
    var isInitialLoad = true;
    // category 파라미터가 있으면 초기 로드 아님으로 간주
    try {
      var paramsForCategory = new URLSearchParams(window.location.search);
      if (paramsForCategory.get("category")) {
        isInitialLoad = false;
      }
    } catch (_) {}
    var input = document.getElementById("post-search-input");
    if (!input) return;

    var entries = Array.prototype.slice.call(
      document.querySelectorAll(".blog-posts .blog-entry")
    );
    var paginationEl = document.querySelector(".pagination");
    var countEl = document.getElementById("search-count");
    var noResultsEl = document.getElementById("no-results");
    var titleEl = document.getElementById("category-title");
    var pageSize = 5;
    var currentPage = 1;

    function normalize(text) {
      return (text || "").toString().toLowerCase().replace(/\s+/g, " ").trim();
    }

    function getMatched() {
      return entries.filter(function (li) {
        return li.getAttribute("data-match") !== "0";
      });
    }

    function renderPagination(totalPages) {
      if (!paginationEl) return;
      if (totalPages <= 1) {
        paginationEl.innerHTML = "";
        return;
      }

      var html = "";
      html += '<a href="#" class="prev-next-button" data-page="prev">◀</a>';
      var pages = [];
      var start = Math.max(1, currentPage - 2);
      var end = Math.min(totalPages, currentPage + 2);

      // 항상 첫 페이지
      pages.push(1);

      // 첫 페이지와 시작 사이 간격 처리
      if (start > 2) {
        pages.push("...");
      }

      // 윈도우 구간 (1, totalPages는 중복 피함)
      for (var i = start; i <= end; i++) {
        if (i !== 1 && i !== totalPages) {
          pages.push(i);
        }
      }

      // 끝 구간 앞 간격 처리
      if (end < totalPages - 1) {
        pages.push("...");
      }

      // 항상 마지막 페이지
      if (totalPages > 1) {
        pages.push(totalPages);
      }

      pages.forEach(function (p) {
        if (p === "...") {
          html += '<span class="page-ellipsis">…</span>';
        } else {
          var cls = "page-number" + (p === currentPage ? " current" : "");
          html +=
            '<a href="#" class="' +
            cls +
            '" data-page="' +
            p +
            '">' +
            p +
            "</a>";
        }
      });
      html += '<a href="#" class="prev-next-button" data-page="next">▶</a>';
      paginationEl.innerHTML = html;

      Array.prototype.forEach.call(
        paginationEl.querySelectorAll("[data-page]"),
        function (a) {
          a.addEventListener("click", function (e) {
            e.preventDefault();
            var raw = this.getAttribute("data-page");
            if (raw === "prev") {
              renderPage(currentPage - 1);
            } else if (raw === "next") {
              renderPage(currentPage + 1);
            } else {
              var t = parseInt(raw, 10) || 1;
              renderPage(t);
            }
            try {
              window.scrollTo({ top: 0, behavior: "smooth" });
            } catch (_) {
              window.scrollTo(0, 0);
            }
          });
        }
      );
    }

    function renderPage(page) {
      var matched = getMatched();
      var total = matched.length;
      var totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(Math.max(1, page), totalPages); // 모두 숨기고 애니메이션 상태 초기화

      entries.forEach(function (li) {
        li.style.display = "none";

        // ▼▼▼▼▼ [수정] 이 부분을 추가하세요 ▼▼▼▼▼
        // 애니메이션 효과를 확실히 제거하여 다음 애니메이션과의 충돌을 방지합니다.
        li.style.transition = "none";
        // ▲▲▲▲▲ [수정] 이 부분을 추가하세요 ▲▲▲▲▲

        li.style.opacity = "0";
        li.style.transform = "translateY(20px)";
      });

      var start = (currentPage - 1) * pageSize;
      var end = start + pageSize;
      var visibleItems = matched.slice(start, end); // 순차적으로 나타나는 애니메이션

      visibleItems.forEach(function (li, index) {
        li.style.display = "";
        setTimeout(function () {
          // 여기서 새로운 transition을 적용합니다.
          li.style.transition = "opacity 0.5s ease, transform 0.5s ease";
          li.style.opacity = "1";
          li.style.transform = "translateY(0)";
        }, index * 100); // 100ms씩 지연
      });

      if (countEl) countEl.textContent = String(total);
      if (noResultsEl) noResultsEl.style.display = total ? "none" : "";
      renderPagination(totalPages);
    }

    function filter() {
      isInitialLoad = false;
      var q = normalize(input.value);
      var visible = 0;

      // 로딩 효과 시작
      var searchBtn = document.getElementById("post-search-btn");
      if (searchBtn) {
        searchBtn.style.opacity = "0.6";
        searchBtn.disabled = true;
      }

      // 검색 처리 (약간의 지연으로 로딩 효과 강조)
      setTimeout(function () {
        entries.forEach(function (li) {
          var title = normalize((li.querySelector("h2") || {}).textContent);
          var body = normalize((li.querySelector("p") || {}).textContent);
          var match = !q || title.indexOf(q) !== -1 || body.indexOf(q) !== -1;
          li.setAttribute("data-match", match ? "1" : "0");
          if (match) visible++;
        });

        if (q) {
          if (titleEl) titleEl.innerHTML = "<b>검색 결과</b>";
          if (countEl) {
            countEl.textContent = String(visible);
          }
          if (noResultsEl) noResultsEl.style.display = visible ? "none" : "";
        } else {
          if (titleEl) titleEl.innerHTML = "<b>최근 포스트</b>";
          if (noResultsEl) noResultsEl.style.display = "none";
        }

        renderPage(1);

        // 버튼 복원
        if (searchBtn) {
          searchBtn.style.opacity = "1";
          searchBtn.textContent = "검색";
          searchBtn.disabled = false;
        }

        try {
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (_) {
          window.scrollTo(0, 0);
        }
      }, 300); // 300ms 로딩 효과
    }

    var btn = document.getElementById("post-search-btn");
    if (btn) {
      btn.addEventListener("click", filter);
    }
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        filter();
      }
    });

    // 검색어가 쿼리에 있으면 초기값 설정 (?q=...)
    try {
      var params = new URLSearchParams(window.location.search);
      var q = params.get("q");
      if (q) {
        input.value = q;
        filter();
      }
    } catch (e) {}

    // 초기 로드 시 전체 기준으로 페이지네이션 구성
    if (isInitialLoad) {
      setTimeout(function () {
        // setTimeout 내부에서 한 번 더 체크하여, 찰나의 순간에 필터가 클릭되는 경우를 방지합니다.
        if (!isInitialLoad) return;

        entries.forEach(function (li) {
          li.setAttribute("data-match", "1");
        });
        renderPage(1);
        isInitialLoad = false; // 최초 실행 후 플래그를 false로 변경해 재실행을 막습니다.
      }, 10);
    }

    // 검색창 호버 효과 추가
    var searchInput = document.getElementById("post-search-input");
    var searchBtn = document.getElementById("post-search-btn");

    if (searchInput) {
      searchInput.addEventListener("focus", function () {
        this.style.borderColor = "#f5e6a3";
        this.style.boxShadow = "0 0 0 2px rgba(245, 230, 163, 0.3)";
      });
      searchInput.addEventListener("blur", function () {
        this.style.borderColor = "#ddd";
        this.style.boxShadow = "none";
      });
    }

    if (searchBtn) {
      searchBtn.addEventListener("mouseenter", function () {
        this.style.backgroundColor = "#fffae0";
        this.style.transform = "scale(1.02)";
      });
      searchBtn.addEventListener("mouseleave", function () {
        this.style.backgroundColor = "#fcfbf5";
        this.style.transform = "scale(1)";
      });
    }
  })();
</script>
